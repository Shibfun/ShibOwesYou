<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOU Wallet - Premium Asset Management</title>
    <link rel="icon" type="image/png" href="https://www.woofswap.finance/image/tokens/sou.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #667eea; --primary-light: #8b9eff; --primary-dark: #5568d3;
            --accent: #764ba2; --accent-light: #9b7ec4; --success: #10b981;
            --warning: #f59e0b; --error: #ef4444; --dark-1: #0a0e27;
            --dark-2: #0f1629; --dark-3: #1a1f3a; --dark-4: #232d4d;
            --text-primary: #f8fafc; --text-secondary: #cbd5e1; --text-tertiary: #94a3b8;
            --border: rgba(255, 255, 255, 0.08); --border-focus: rgba(102, 126, 234, 0.5);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--dark-1) 0%, var(--dark-2) 50%, var(--dark-3) 100%);
            color: var(--text-primary); min-height: 100vh; position: relative;
            overflow-x: hidden; display: flex; flex-direction: column;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.08) 0%, transparent 50%);
            pointer-events: none; z-index: 0;
        }
        nav {
            position: fixed; top: 0; left: 0; right: 0; background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(25px); border-bottom: 1px solid var(--border);
            padding: 10px 40px; display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .logo-nav { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 800; color: var(--text-primary); text-decoration: none; }
        .logo-nav img { width: 30px; height: 30px; border-radius: 8px; object-fit: contain; }
        
        .nav-right { display: flex; align-items: center; gap: 16px; }
        .lang-switch { display: flex; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 3px; border: 1px solid var(--border); }
        .lang-btn { padding: 5px 10px; border: none; background: transparent; color: var(--text-tertiary); font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 9px; transition: 0.2s; }
        .lang-btn.active { background: var(--primary); color: white; }

        .wrapper { position: relative; z-index: 1; padding-top: 80px; flex: 1; padding-bottom: 40px; }
        .app-container { max-width: 500px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 24px; }
        
        .card { background: rgba(26, 31, 58, 0.7); backdrop-filter: blur(40px); border-radius: 32px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5); }
        .card-content { padding: 28px; }

        .tab-nav { display: flex; background: rgba(0, 0, 0, 0.25); padding: 6px; margin-bottom: 24px; border-radius: 18px; border: 1px solid var(--border); flex-wrap: wrap; }
        .tab-btn { flex: 1; min-width: 80px; padding: 12px 8px; border: none; background: transparent; color: var(--text-tertiary); font-weight: 700; font-size: 13px; cursor: pointer; border-radius: 14px; transition: var(--transition); }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 8px 16px rgba(102, 126, 234, 0.25); }

        .balance-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 24px; }
        .balance-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid var(--border); padding: 20px; border-radius: 24px; text-align: center;
        }
        .balance-card.direct { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%); }
        
        .balance-header { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .balance-header img { width: 24px; height: 24px; object-fit: contain; }
        .balance-val { font-size: 32px; font-weight: 800; color: var(--text-primary); margin-bottom: 4px; font-family: 'Space Mono', monospace; letter-spacing: -1px; }
        .balance-label { font-size: 10px; color: var(--text-tertiary); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        .addr-pill {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: 16px;
            font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-secondary);
            margin-top: 12px; border: 1px solid var(--border);
        }
        .copy-icon { cursor: pointer; padding: 4px; transition: 0.2s; color: var(--primary-light); opacity: 0.7; }
        .copy-icon:hover { color: white; opacity: 1; transform: scale(1.1); }

        .input-section { margin-bottom: 24px; }
        .input-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: var(--text-secondary); font-weight: 700; padding-left: 4px; }
        .input-box { 
            background: rgba(15, 22, 41, 0.6); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            padding: 16px 20px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: var(--transition);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .input-box:focus-within { 
            border-color: var(--border-focus); 
            background: rgba(15, 22, 41, 0.8); 
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.15), inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .token-badge { 
            display: flex; align-items: center; gap: 8px; padding: 6px 12px; 
            background: rgba(102, 126, 234, 0.1); border-radius: 12px; 
            border: 1px solid rgba(102, 126, 234, 0.2); 
        }
        .token-logo-small { width: 18px; height: 18px; object-fit: contain; }
        
        .domain-suffix { font-weight: 700; color: var(--primary-light); font-size: 16px; opacity: 0.9; padding-right: 4px; }

        input { flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 16px; font-weight: 600; outline: none; }
        input::placeholder { color: var(--text-tertiary); opacity: 0.5; }

        .percent-row { display: flex; gap: 8px; margin-top: 14px; }
        .percent-btn { 
            flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--border); 
            background: rgba(0,0,0,0.2); color: var(--text-tertiary); font-size: 11px; 
            font-weight: 700; cursor: pointer; transition: 0.2s; 
        }
        .percent-btn:hover { border-color: var(--primary); color: white; background: rgba(102, 126, 234, 0.1); }

        .action-button { 
            width: 100%; padding: 20px; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); 
            border: none; border-radius: 20px; color: white; font-size: 16px; 
            font-weight: 800; cursor: pointer; transition: var(--transition); 
            margin-top: 12px; box-shadow: 0 10px 20px rgba(102, 126, 234, 0.2);
        }
        .action-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4); }
        .action-button:active { transform: translateY(0); }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .tip-text { margin-top: 16px; font-size: 11px; color: var(--text-tertiary); text-align: center; opacity: 0.8; font-weight: 500; }

        .wallet-info { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(35, 45, 77, 0.6); border: 1px solid var(--border); border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .wallet-info:hover { border-color: var(--primary-light); background: rgba(35, 45, 77, 0.8); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--error); }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); }

        #toast-container { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { min-width: 300px; max-width: 90vw; padding: 16px 24px; border-radius: 20px; background: rgba(15, 22, 41, 0.95); backdrop-filter: blur(20px); border: 1px solid var(--border); color: white; font-weight: 600; font-size: 14px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; pointer-events: auto; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        .toast.info { border-color: var(--primary); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

        footer { text-align: center; padding: 30px; font-size: 12px; color: var(--text-tertiary); opacity: 0.5; font-weight: 500; letter-spacing: 0.5px; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .id-preview { margin-top: 14px; padding: 14px; background: rgba(0,0,0,0.25); border-radius: 18px; display: none; border: 1px solid var(--border); }
        .id-preview-label { font-size: 10px; color: var(--text-tertiary); margin-bottom: 6px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        
        .info-row { display: flex; justify-content: space-between; align-items: center; width: 100%; font-size: 13px; }
        .info-row span:first-child { color: var(--text-tertiary); }
        .info-row span:last-child { color: var(--text-primary); font-weight: 600; word-break: break-all; text-align: right; margin-left: 10px; }
    </style>
</head>
<body>
    <nav>
        <a href="#" class="logo-nav"><img src="https://www.woofswap.finance/image/tokens/sou.png" alt="SOU">SOU Wallet</a>
        <div class="nav-right">
            <div class="lang-switch">
                <button class="lang-btn active" id="btn-zh" onclick="setLang('zh')">‰∏≠</button>
                <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
            </div>
            <div class="wallet-info" onclick="connectWallet()">
                <div class="status-dot" id="walletDot"></div>
                <span id="walletAddr" data-i18n="connectWallet">ËøûÊé•Èí±ÂåÖ</span>
            </div>
        </div>
    </nav>

    <div id="toast-container"></div>

    <div class="wrapper">
        <div class="app-container">
            <div class="card">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="assets" data-i18n="tabAssets">ËµÑ‰∫ß</button>
                    <button class="tab-btn" data-tab="send" data-i18n="tabSend">ÂèëÈÄÅ</button>
                    <button class="tab-btn" data-tab="domain" data-i18n="tabDomain">ÂüüÂêçËΩ¨Ë¥¶</button>
                    <button class="tab-btn" data-tab="query" data-i18n="tabQuery">Êü•ËØ¢</button>
                </div>

                <div class="card-content">
                    <!-- Assets Tab -->
                    <div class="tab-content active" id="assetsTab">
                        <div class="balance-grid">
                            <!-- MetaMask EOA Balance -->
                            <div class="balance-card direct">
                                <div class="balance-header">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" alt="SOU">
                                    <span class="balance-label" data-i18n="eoaBalanceLabel">ËøûÊé•Èí±ÂåÖ‰ΩôÈ¢ù (EOA)</span>
                                </div>
                                <div class="balance-val" id="eoaBalanceDisplay">0.00</div>
                                <div class="addr-pill">
                                    <span id="eoaAddrFull" style="opacity: 0.8;">Êú™ËøûÊé•</span>
                                    <span class="copy-icon" onclick="copyText('eoaAddrFull')">üìã</span>
                                </div>
                            </div>

                            <!-- SOU Smart Wallet Balance -->
                            <div id="noWalletUI" class="empty-state" style="text-align: center; padding: 20px; border: 1px dashed var(--border); border-radius: 24px;">
                                <p data-i18n="noWalletTip" style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary); font-weight: 500;">ÊÇ®Â∞öÊú™Êã•Êúâ SOU Êô∫ËÉΩÈí±ÂåÖ</p>
                                <div class="input-section" style="margin-bottom: 16px;">
                                    <div class="input-box">
                                        <input type="text" id="regID" data-i18n-placeholder="idPlaceholder" placeholder="ËæìÂÖ•Êï∞Â≠ó ID (Â¶Ç: 888)">
                                    </div>
                                </div>
                                <button class="action-button" onclick="createWallet()" data-i18n="btnCreate">ÂàõÂª∫Èí±ÂåÖ</button>
                            </div>

                            <div id="hasWalletUI" class="balance-card" style="display: none;">
                                <div class="balance-header">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" alt="SOU">
                                    <span class="balance-label" data-i18n="smartBalanceLabel">SOU Êô∫ËÉΩÈí±ÂåÖ‰ΩôÈ¢ù</span>
                                </div>
                                <div class="balance-val" id="souBalance">0.00</div>
                                <div class="info-row" style="justify-content: center; gap: 8px;">
                                    <span style="opacity: 0.6;">ID:</span> <b id="myID" style="color: var(--primary-light); font-size: 14px;">-</b>
                                </div>
                                <div class="addr-pill">
                                    <span id="myWalletAddrFull" style="opacity: 0.8;">0x...</span>
                                    <span class="copy-icon" onclick="copyText('myWalletAddrFull')">üìã</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Send Tab (Smart Wallet Transfer) -->
                    <div class="tab-content" id="sendTab">
                        <div class="input-section">
                            <div class="input-label" data-i18n="receiverLabel">Êé•Êî∂ËÄÖ (Âú∞ÂùÄÊàñÊï∞Â≠ó ID)</div>
                            <div class="input-box">
                                <input type="text" id="sendTarget" oninput="previewTarget()" data-i18n-placeholder="targetPlaceholder" placeholder="0x... Êàñ Êï∞Â≠ó ID">
                            </div>
                            <div id="targetPreview" class="id-preview">
                                <div class="id-preview-label" data-i18n="targetAddrLabel">Ëß£ÊûêÂú∞ÂùÄ</div>
                                <div class="addr-pill" style="margin-top: 6px; background: rgba(0,0,0,0.15);">
                                    <span id="previewAddr" style="font-size: 10px;">-</span>
                                    <span class="copy-icon" onclick="copyText('previewAddr')">üìã</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-section">
                            <div class="input-label">
                                <span data-i18n="amountLabel">Êï∞Èáè</span>
                                <span style="font-size: 11px; opacity: 0.6; font-family: 'Space Mono';">Balance: <span class="sendBalText">0.00</span> SOU</span>
                            </div>
                            <div class="input-box">
                                <input type="number" id="sendAmt" placeholder="0.0">
                                <div class="token-badge">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" class="token-logo-small">
                                    <span style="font-size: 13px; font-weight: 800;">SOU</span>
                                </div>
                            </div>
                            <div class="percent-row">
                                <button class="percent-btn" onclick="setPercent(0.25, 'sendAmt', 'smart')">25%</button>
                                <button class="percent-btn" onclick="setPercent(0.5, 'sendAmt', 'smart')">50%</button>
                                <button class="percent-btn" onclick="setPercent(0.75, 'sendAmt', 'smart')">75%</button>
                                <button class="percent-btn" onclick="setPercent(1.0, 'sendAmt', 'smart')">MAX</button>
                            </div>
                        </div>
                        <button class="action-button" onclick="handleSend()" data-i18n="btnSend">Á´ãÂç≥ÂèëÈÄÅ</button>
                        <div class="tip-text" data-i18n="smartTip">Ê∏©È¶®ÊèêÁ§∫ÔºöSOU Êô∫ËÉΩÈí±ÂåÖ‰ªÖÊîØÊåÅÂú® SOU Èí±ÂåÖÂú∞ÂùÄ‰πãÈó¥ËøõË°åËΩ¨Ë¥¶</div>
                    </div>

                    <!-- Domain Transfer Tab (Direct EOA Transfer) -->
                    <div class="tab-content" id="domainTab">
                        <div class="input-section">
                            <div class="input-label" data-i18n="domainLabel">Êé•Êî∂ËÄÖÂüüÂêç</div>
                            <div class="input-box">
                                <input type="text" id="domainTarget" oninput="previewDomain()" data-i18n-placeholder="domainPlaceholder" placeholder="ËæìÂÖ•ÂêçÁß∞">
                                <span class="domain-suffix">.sou</span>
                            </div>
                            <div id="domainPreview" class="id-preview">
                                <div class="id-preview-label" data-i18n="targetAddrLabel">Ëß£ÊûêÂú∞ÂùÄ</div>
                                <div class="addr-pill" style="margin-top: 6px; background: rgba(0,0,0,0.15);">
                                    <span id="previewDomainAddr" style="font-size: 10px;">-</span>
                                    <span class="copy-icon" onclick="copyText('previewDomainAddr')">üìã</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-section">
                            <div class="input-label">
                                <span data-i18n="amountLabel">Êï∞Èáè</span>
                                <span style="font-size: 11px; opacity: 0.6; font-family: 'Space Mono';">Balance: <span class="directBalText">0.00</span> SOU</span>
                            </div>
                            <div class="input-box">
                                <input type="number" id="domainAmt" placeholder="0.0">
                                <div class="token-badge">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" class="token-logo-small">
                                    <span style="font-size: 13px; font-weight: 800;">SOU</span>
                                </div>
                            </div>
                            <div class="percent-row">
                                <button class="percent-btn" onclick="setPercent(0.25, 'domainAmt', 'direct')">25%</button>
                                <button class="percent-btn" onclick="setPercent(0.5, 'domainAmt', 'direct')">50%</button>
                                <button class="percent-btn" onclick="setPercent(0.75, 'domainAmt', 'direct')">75%</button>
                                <button class="percent-btn" onclick="setPercent(1.0, 'domainAmt', 'direct')">MAX</button>
                            </div>
                        </div>
                        <button class="action-button" onclick="handleDomainSend()" data-i18n="btnSend">Á´ãÂç≥ÂèëÈÄÅ</button>
                        <div class="tip-text" data-i18n="domainTip">Ê∏©È¶®ÊèêÁ§∫ÔºöÂüüÂêçËΩ¨Ë¥¶ÊîØÊåÅÂ∞Ü SOU ÂèëÈÄÅËá≥‰ªªÊÑèËß£ÊûêÂêéÁöÑÂú∞ÂùÄ</div>
                    </div>

                    <!-- Query Tab -->
                    <div class="tab-content" id="queryTab">
                        <div class="input-section">
                            <div class="input-label" data-i18n="searchLabel">ÊêúÁ¥¢Âú∞ÂùÄ„ÄÅID ÊàñÂüüÂêç</div>
                            <div class="input-box">
                                <input type="text" id="queryInput" data-i18n-placeholder="searchPlaceholder" placeholder="Âú∞ÂùÄ„ÄÅÊï∞Â≠ó ID Êàñ .sou ÂüüÂêç">
                            </div>
                        </div>
                        <button class="action-button" style="background: var(--dark-4); box-shadow: none;" onclick="handleQuery()" data-i18n="btnSearch">ÊêúÁ¥¢</button>
                        <div id="queryResult" class="info-row" style="flex-direction: column; gap: 10px; margin-top: 20px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px; display: none; border: 1px solid var(--border);">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        &copy; 2026 SOU Ecosystem. All Rights Reserved.
    </footer>

    <script>
        const FACTORY_ADDR = "0x02E54e08Be9fE047C6E6aEd89A430AcBe4708E9e";
        const ID_CONTRACT_ADDR = "0x31CCB08535398AFEe394E8cd8d34e72973C08cc9";
        const SOU_ADDR = "0xb65bd36fef84ebc5114cfd803a4f25b2b57f7777";
        const BSC_CHAIN_ID = 56;
        
        const i18n = {
            zh: {
                connectWallet: "ËøûÊé•Èí±ÂåÖ",
                tabAssets: "ËµÑ‰∫ß",
                tabSend: "ÂèëÈÄÅ",
                tabDomain: "ÂüüÂêçËΩ¨Ë¥¶",
                tabQuery: "Êü•ËØ¢",
                eoaBalanceLabel: "ËøûÊé•Èí±ÂåÖ‰ΩôÈ¢ù (EOA)",
                smartBalanceLabel: "SOU Êô∫ËÉΩÈí±ÂåÖ‰ΩôÈ¢ù",
                noWalletTip: "ÊÇ®Â∞öÊú™Êã•Êúâ SOU Êô∫ËÉΩÈí±ÂåÖ",
                idPlaceholder: "ËæìÂÖ•Êï∞Â≠ó ID (Â¶Ç: 888)",
                btnCreate: "ÂàõÂª∫Èí±ÂåÖ",
                souBalanceLabel: "SOU ‰ΩôÈ¢ù",
                receiverLabel: "Êé•Êî∂ËÄÖ (Âú∞ÂùÄÊàñÊï∞Â≠ó ID)",
                domainLabel: "Êé•Êî∂ËÄÖÂüüÂêç",
                targetPlaceholder: "0x... Êàñ Êï∞Â≠ó ID",
                domainPlaceholder: "ËæìÂÖ•ÂêçÁß∞",
                targetAddrLabel: "Ëß£ÊûêÂú∞ÂùÄ",
                amountLabel: "Êï∞Èáè",
                btnSend: "Á´ãÂç≥ÂèëÈÄÅ",
                searchLabel: "ÊêúÁ¥¢Âú∞ÂùÄ„ÄÅID ÊàñÂüüÂêç",
                searchPlaceholder: "Âú∞ÂùÄ„ÄÅÊï∞Â≠ó ID Êàñ .sou ÂüüÂêç",
                btnSearch: "ÊêúÁ¥¢",
                msgCreateSuccess: "ÂàõÂª∫ÊàêÂäüÔºÅ",
                msgSendSuccess: "ËΩ¨Ë¥¶ÊàêÂäüÔºÅ",
                msgIdNotFound: "Êú™Êü•ËØ¢Âà∞Áõ∏ÂÖ≥ ID ÊàñÂüüÂêç",
                msgInvalidTarget: "ÁõÆÊ†áÂú∞ÂùÄÈùûÊ≥ïÔºöÈùû SOU Èí±ÂåÖÊàñÊú™Âú®ÁôΩÂêçÂçï‰∏≠",
                msgQueryEmpty: "Êú™Êü•ËØ¢Âà∞Áõ∏ÂÖ≥‰ø°ÊÅØ",
                msgQueryWallet: "ÂÖ≥ËÅîÈí±ÂåÖ",
                msgQueryOwner: "ÊâÄÊúâËÄÖ",
                msgQueryIsSOU: "ÊòØÂê¶‰∏∫ SOU Èí±ÂåÖ",
                msgYes: "ÊòØ",
                msgNo: "Âê¶",
                msgError: "Êìç‰ΩúÂ§±Ë¥•",
                msgConnectMetaMask: "ËØ∑ÂÆâË£Ö MetaMask",
                msgNetworkError: "ËØ∑ÂàáÊç¢Ëá≥ BSC ‰∏ªÁΩë (Chain ID: 56)",
                msgCopySuccess: "Â§çÂà∂ÊàêÂäüÔºÅ",
                smartTip: "Ê∏©È¶®ÊèêÁ§∫ÔºöSOU Êô∫ËÉΩÈí±ÂåÖ‰ªÖÊîØÊåÅÂú® SOU Èí±ÂåÖÂú∞ÂùÄ‰πãÈó¥ËøõË°åËΩ¨Ë¥¶",
                domainTip: "Ê∏©È¶®ÊèêÁ§∫ÔºöÂüüÂêçËΩ¨Ë¥¶ÊîØÊåÅÂ∞Ü SOU ÂèëÈÄÅËá≥‰ªªÊÑèËß£ÊûêÂêéÁöÑÂú∞ÂùÄ"
            },
            en: {
                connectWallet: "Connect Wallet",
                tabAssets: "Assets",
                tabSend: "Send",
                tabDomain: "Domain Send",
                tabQuery: "Query",
                eoaBalanceLabel: "Connected Balance (EOA)",
                smartBalanceLabel: "SOU Smart Wallet Balance",
                noWalletTip: "No SOU Wallet Found",
                idPlaceholder: "Enter numeric ID (e.g., 888)",
                btnCreate: "Create Wallet",
                souBalanceLabel: "SOU Balance",
                receiverLabel: "Receiver (Address or ID)",
                domainLabel: "Receiver Domain",
                targetPlaceholder: "0x... or Numeric ID",
                domainPlaceholder: "Enter name",
                targetAddrLabel: "Resolved Address",
                amountLabel: "Amount",
                btnSend: "Send Now",
                searchLabel: "Search Address, ID or Domain",
                searchPlaceholder: "Address, ID or .sou Domain",
                btnSearch: "Search",
                msgCreateSuccess: "Created Successfully!",
                msgSendSuccess: "Sent Successfully!",
                msgIdNotFound: "ID or Domain not found",
                msgInvalidTarget: "Invalid target: Not a SOU Wallet or not whitelisted",
                msgQueryEmpty: "No information found",
                msgQueryWallet: "Linked Wallet",
                msgQueryOwner: "Owner",
                msgQueryIsSOU: "Is SOU Wallet",
                msgYes: "Yes",
                msgNo: "No",
                msgError: "Operation Failed",
                msgConnectMetaMask: "Please install MetaMask",
                msgNetworkError: "Please switch to BSC Mainnet (Chain ID: 56)",
                msgCopySuccess: "Copied!",
                smartTip: "Tip: SOU Smart Wallet only supports transfers between SOU wallet addresses",
                domainTip: "Tip: Domain Send supports sending SOU to any resolved address"
            }
        };

        let currentLang = 'zh';
        let userSmartSouBal = "0";
        let userDirectSouBal = "0";

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = i18n[lang][el.dataset.i18n]);
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = i18n[lang][el.dataset.i18nPlaceholder]);
            document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
        }

        const FACTORY_ABI = [
            "function createWallet(string id) external returns (address)",
            "function ownerToWallet(address) view returns (address)",
            "function walletToOwner(address) view returns (address)",
            "function isSOUWallet(address) view returns (bool)",
            "function idToWallet(string) view returns (address)",
            "function walletToId(address) view returns (string)",
            "function globalRestrictionLifted() view returns (bool)",
            "function whitelist(address) view returns (bool)"
        ];
        const ID_ABI = [
            "function resolve(string calldata inputName) external view returns (address)",
            "function primaryName(address) view returns (string)",
            "function tokenIdByIdLower(string) view returns (uint256)",
            "function ownerOf(uint256) view returns (address)"
        ];
        const WALLET_ABI = ["function transfer(address to, uint256 amount, address token) external"];
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address to, uint256 amount) external returns (bool)"
        ];

        let provider, signer, userAddr, userWallet;

        async function connectWallet() {
            if (!window.ethereum) return showToast(i18n[currentLang].msgConnectMetaMask, 'error');
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const { chainId } = await provider.getNetwork();
            if (chainId !== BSC_CHAIN_ID) return showToast(i18n[currentLang].msgNetworkError, 'error');

            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddr = await signer.getAddress();
            
            document.getElementById('walletAddr').innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
            document.getElementById('eoaAddrFull').innerText = userAddr;
            document.getElementById('walletDot').classList.add('connected');
            await refreshUI();
        }

        async function refreshUI() {
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            const sou = new ethers.Contract(SOU_ADDR, ERC20_ABI, provider);

            const directBal = await sou.balanceOf(userAddr);
            userDirectSouBal = ethers.utils.formatUnits(directBal, 18);
            document.getElementById('eoaBalanceDisplay').innerText = userDirectSouBal;
            document.querySelectorAll('.directBalText').forEach(el => el.innerText = userDirectSouBal);

            userWallet = await factory.ownerToWallet(userAddr);
            if (userWallet !== "0x0000000000000000000000000000000000000000") {
                document.getElementById('noWalletUI').style.display = 'none';
                document.getElementById('hasWalletUI').style.display = 'block';
                document.getElementById('myID').innerText = await factory.walletToId(userWallet);
                document.getElementById('myWalletAddrFull').innerText = userWallet;
                
                const smartBal = await sou.balanceOf(userWallet);
                userSmartSouBal = ethers.utils.formatUnits(smartBal, 18);
                document.getElementById('souBalance').innerText = userSmartSouBal;
                document.querySelectorAll('.sendBalText').forEach(el => el.innerText = userSmartSouBal);
            } else {
                document.getElementById('noWalletUI').style.display = 'block';
                document.getElementById('hasWalletUI').style.display = 'none';
                document.querySelectorAll('.sendBalText').forEach(el => el.innerText = "0.00");
            }
        }

        async function createWallet() {
            const id = document.getElementById('regID').value;
            if (!id || isNaN(id)) return;
            try {
                const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, signer);
                const tx = await factory.createWallet(id);
                showToast("‰∫§ÊòìÂ∑≤Êèê‰∫§...", 'info');
                await tx.wait();
                showToast(i18n[currentLang].msgCreateSuccess, 'success');
                await refreshUI();
            } catch (e) { showToast(i18n[currentLang].msgError, 'error'); }
        }

        async function previewTarget() {
            const target = document.getElementById('sendTarget').value.trim();
            const previewBox = document.getElementById('targetPreview');
            const previewAddr = document.getElementById('previewAddr');
            
            if (!target) { previewBox.style.display = 'none'; return; }

            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            if (!target.startsWith("0x") && !isNaN(target)) {
                const addr = await factory.idToWallet(target);
                if (addr !== "0x0000000000000000000000000000000000000000") {
                    previewAddr.innerText = addr;
                    previewBox.style.display = 'block';
                } else { previewBox.style.display = 'none'; }
            } else { previewBox.style.display = 'none'; }
        }

        async function previewDomain() {
            let domainInput = document.getElementById('domainTarget').value.trim();
            const previewBox = document.getElementById('domainPreview');
            const previewAddr = document.getElementById('previewDomainAddr');

            if (!domainInput) { previewBox.style.display = 'none'; return; }
            
            let searchName = domainInput.toLowerCase();
            if (searchName.endsWith(".sou")) {
                searchName = searchName.substring(0, searchName.length - 4);
            }

            try {
                const idContract = new ethers.Contract(ID_CONTRACT_ADDR, ID_ABI, provider);
                const addr = await idContract.resolve(searchName);
                if (addr !== "0x0000000000000000000000000000000000000000") {
                    previewAddr.innerText = addr;
                    previewBox.style.display = 'block';
                } else { previewBox.style.display = 'none'; }
            } catch (e) { previewBox.style.display = 'none'; }
        }

        function setPercent(p, inputId, type) {
            let baseBal = (type === 'smart') ? userSmartSouBal : userDirectSouBal;
            let val = parseFloat(baseBal) * p;
            if (p === 1.0) val = Math.floor(val * 1000000) / 1000000;
            document.getElementById(inputId).value = val;
        }

        async function handleSend() {
            let target = document.getElementById('sendTarget').value.trim();
            const amt = document.getElementById('sendAmt').value;
            if (!target || !amt) return;
            
            let targetAddr = target;
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            if (!target.startsWith("0x") && !isNaN(target)) {
                targetAddr = await factory.idToWallet(target);
                if (targetAddr === "0x0000000000000000000000000000000000000000") return showToast(i18n[currentLang].msgIdNotFound, 'error');
            }

            try {
                const isSOU = await factory.isSOUWallet(targetAddr);
                const globalLifted = await factory.globalRestrictionLifted();
                const isWhite = await factory.whitelist(userWallet);
                
                if (!isSOU && !globalLifted && !isWhite) return showToast(i18n[currentLang].msgInvalidTarget, 'error');

                const wallet = new ethers.Contract(userWallet, WALLET_ABI, signer);
                const tx = await wallet.transfer(targetAddr, ethers.utils.parseUnits(amt.toString(), 18), SOU_ADDR);
                showToast("‰∫§ÊòìÂ∑≤Êèê‰∫§...", 'info');
                await tx.wait();
                showToast(i18n[currentLang].msgSendSuccess, 'success');
                await refreshUI();
            } catch (e) { showToast(i18n[currentLang].msgError, 'error'); }
        }

        async function handleDomainSend() {
            let domainInput = document.getElementById('domainTarget').value.trim();
            const amt = document.getElementById('domainAmt').value;
            if (!domainInput || !amt) return;

            let searchName = domainInput.toLowerCase();
            if (searchName.endsWith(".sou")) {
                searchName = searchName.substring(0, searchName.length - 4);
            }

            try {
                const idContract = new ethers.Contract(ID_CONTRACT_ADDR, ID_ABI, provider);
                const targetAddr = await idContract.resolve(searchName);
                if (targetAddr === "0x0000000000000000000000000000000000000000") return showToast(i18n[currentLang].msgIdNotFound, 'error');
                
                const sou = new ethers.Contract(SOU_ADDR, ERC20_ABI, signer);
                const tx = await sou.transfer(targetAddr, ethers.utils.parseUnits(amt.toString(), 18));
                showToast("‰∫§ÊòìÂ∑≤Êèê‰∫§...", 'info');
                await tx.wait();
                showToast(i18n[currentLang].msgSendSuccess, 'success');
                await refreshUI();
            } catch (e) { showToast(i18n[currentLang].msgError, 'error'); }
        }

        async function handleQuery() {
            const input = document.getElementById('queryInput').value.trim();
            const resBox = document.getElementById('queryResult');
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            const idContract = new ethers.Contract(ID_CONTRACT_ADDR, ID_ABI, provider);
            try {
                let resHtml = "";
                const lang = i18n[currentLang];
                
                if (input.startsWith("0x") && input.length === 42) {
                    // 1. Query by Address
                    const wallet = await factory.ownerToWallet(input);
                    const owner = await factory.walletToOwner(input);
                    if (wallet !== "0x0000000000000000000000000000000000000000") resHtml += `<div class="info-row"><span>${lang.msgQueryWallet}:</span><span>${wallet} <span class="copy-icon" onclick="copyValue('${wallet}')">üìã</span></span></div>`;
                    if (owner !== "0x0000000000000000000000000000000000000000") resHtml += `<div class="info-row"><span>${lang.msgQueryOwner}:</span><span>${owner} <span class="copy-icon" onclick="copyValue('${owner}')">üìã</span></span></div>`;
                    resHtml += `<div class="info-row"><span>${lang.msgQueryIsSOU}:</span><span>${await factory.isSOUWallet(input) ? lang.msgYes : lang.msgNo}</span></div>`;
                } else if (input.toLowerCase().endsWith(".sou")) {
                    // 2. Query by Domain (Must end with .sou)
                    let searchName = input.toLowerCase().substring(0, input.length - 4);
                    const addr = await idContract.resolve(searchName);
                    resHtml = addr !== "0x0000000000000000000000000000000000000000" ? `<div class="info-row"><span>${lang.msgQueryWallet}:</span><span>${addr} <span class="copy-icon" onclick="copyValue('${addr}')">üìã</span></span></div>` : `<div>${lang.msgIdNotFound}</div>`;
                } else if (!isNaN(input) && input.length > 0) {
                    // 3. Query by Numeric ID
                    const wallet = await factory.idToWallet(input);
                    resHtml = wallet !== "0x0000000000000000000000000000000000000000" ? `<div class="info-row"><span>${lang.msgQueryWallet}:</span><span>${wallet} <span class="copy-icon" onclick="copyValue('${wallet}')">üìã</span></span></div>` : `<div>${lang.msgIdNotFound}</div>`;
                } else {
                    resHtml = `<div>${lang.msgQueryEmpty}</div>`;
                }
                
                resBox.innerHTML = resHtml;
                resBox.style.display = 'flex';
            } catch (e) { showToast(lang.msgError, 'error'); }
        }

        function copyText(id) {
            const txt = document.getElementById(id).innerText;
            if (txt === "Êú™ËøûÊé•" || txt === "0x...") return;
            navigator.clipboard.writeText(txt).then(() => showToast(i18n[currentLang].msgCopySuccess, 'success'));
        }
        function copyValue(val) {
            navigator.clipboard.writeText(val).then(() => showToast(i18n[currentLang].msgCopySuccess, 'success'));
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            };
        });

        if (window.ethereum && window.ethereum.selectedAddress) connectWallet();
        setLang('zh');
    </script>
</body>
</html>

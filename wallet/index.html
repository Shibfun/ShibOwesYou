<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SOU Wallet - Long Data Optimized</title>
    <link rel="icon" type="image/png" href="https://www.woofswap.finance/image/tokens/sou.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --primary-dark: #4f46e5;
            --accent: #a855f7; --accent-light: #c084fc; --success: #10b981;
            --warning: #f59e0b; --error: #ef4444; --dark-1: #030712;
            --dark-2: #0f172a; --dark-3: #1e293b; --dark-4: #334155;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --text-tertiary: #64748b;
            --border: rgba(255, 255, 255, 0.06); --border-focus: rgba(99, 102, 241, 0.4);
            --glass: rgba(15, 23, 42, 0.65); --glass-heavy: rgba(15, 23, 42, 0.85);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--dark-1);
            color: var(--text-primary); min-height: 100vh; position: relative;
            overflow-x: hidden; display: flex; flex-direction: column;
            line-height: 1.5;
        }
        .bg-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 90% 90%, rgba(168, 85, 247, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 50% 50%, rgba(15, 23, 42, 1) 0%, rgba(3, 7, 18, 1) 100%);
        }

        nav {
            position: fixed; top: 0; left: 0; right: 0; background: var(--glass);
            backdrop-filter: blur(20px); border-bottom: 1px solid var(--border);
            padding: calc(12px + var(--safe-top)) 20px 12px; display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        @media (min-width: 1024px) { nav { padding: 16px 60px; } }
        
        .logo-nav { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 800; color: var(--text-primary); text-decoration: none; }
        .logo-nav img { width: 32px; height: 32px; border-radius: 10px; }
        
        .nav-right { display: flex; align-items: center; gap: 12px; }

        .lang-switch { display: flex; background: rgba(0,0,0,0.4); border-radius: 14px; padding: 4px; border: 1px solid var(--border); }
        .lang-btn { padding: 6px 12px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 700; cursor: pointer; border-radius: 10px; transition: var(--transition); }
        .lang-btn.active { background: var(--primary); color: white; }

        .wrapper { position: relative; z-index: 1; padding-top: calc(80px + var(--safe-top)); flex: 1; padding-bottom: calc(40px + var(--safe-bottom)); }
        .app-container { width: 100%; max-width: 600px; margin: 0 auto; padding: 0 16px; display: flex; flex-direction: column; gap: 24px; }
        
        .card { background: var(--glass-heavy); backdrop-filter: blur(40px); border-radius: 32px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6); }
        .card-content { padding: 20px; }
        @media (min-width: 768px) { .card-content { padding: 32px; } }

        .tab-nav { display: flex; background: rgba(0, 0, 0, 0.3); padding: 6px; margin-bottom: 24px; border-radius: 20px; border: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; gap: 4px; }
        .tab-nav::-webkit-scrollbar { display: none; }
        .tab-btn { flex: 1; min-width: 85px; padding: 12px 10px; border: none; background: transparent; color: var(--text-secondary); font-weight: 700; font-size: 13px; cursor: pointer; border-radius: 16px; transition: var(--transition); white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }

        .balance-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 24px; }
        @media (min-width: 768px) { .balance-grid { grid-template-columns: 1fr 1fr; } }
        
        .balance-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%);
            border: 1px solid var(--border); padding: 24px; border-radius: 28px; text-align: center;
            transition: var(--transition); position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .balance-card.direct { border-left: 4px solid var(--success); }
        .balance-card.smart { border-left: 4px solid var(--primary); }
        
        .balance-header { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px; }
        .balance-header img { width: 24px; height: 24px; }
        
        /* Dynamic Font Size for Balance */
        .balance-val { 
            font-size: clamp(20px, 6vw, 32px); 
            font-weight: 800; color: var(--text-primary); 
            margin-bottom: 4px; font-family: 'Space Mono', monospace; 
            letter-spacing: -1px; width: 100%; overflow: hidden; 
            text-overflow: ellipsis; white-space: nowrap; 
        }
        .balance-label { font-size: 10px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }

        .addr-pill {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.3); padding: 12px 16px; border-radius: 16px;
            font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-secondary);
            margin-top: 16px; border: 1px solid var(--border); width: 100%; gap: 10px;
        }
        /* Address Truncation */
        .addr-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .copy-icon { cursor: pointer; padding: 4px; transition: 0.2s; color: var(--primary-light); opacity: 0.8; flex-shrink: 0; }
        .copy-icon:hover { color: white; opacity: 1; transform: scale(1.2); }

        .input-section { margin-bottom: 24px; }
        .input-label { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; color: var(--text-secondary); font-weight: 700; padding-left: 6px; }
        .input-box { 
            background: rgba(0, 0, 0, 0.3); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            padding: 18px 20px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: var(--transition);
        }
        .input-box:focus-within { border-color: var(--primary); background: rgba(0, 0, 0, 0.4); }
        
        .token-badge { 
            display: flex; align-items: center; gap: 8px; padding: 6px 14px; 
            background: rgba(99, 102, 241, 0.15); border-radius: 14px; 
            border: 1px solid rgba(99, 102, 241, 0.2); flex-shrink: 0;
        }
        .token-logo-small { width: 20px; height: 20px; }
        
        .domain-suffix { font-weight: 800; color: var(--primary-light); font-size: 16px; flex-shrink: 0; }

        input { flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 16px; font-weight: 600; outline: none; width: 100%; min-width: 0; }
        input::placeholder { color: var(--text-tertiary); }

        .percent-row { display: flex; gap: 10px; margin-top: 16px; }
        .percent-btn { 
            flex: 1; padding: 12px 6px; border-radius: 14px; border: 1px solid var(--border); 
            background: rgba(255,255,255,0.03); color: var(--text-secondary); font-size: 11px; 
            font-weight: 700; cursor: pointer; transition: var(--transition); 
        }

        .action-button { 
            width: 100%; padding: 20px; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); 
            border: none; border-radius: 22px; color: white; font-size: 16px; 
            font-weight: 800; cursor: pointer; transition: var(--transition); 
            margin-top: 12px; box-shadow: 0 15px 30px rgba(99, 102, 241, 0.3);
        }
        .action-button:disabled { opacity: 0.4; cursor: not-allowed; }

        .tip-text { margin-top: 20px; font-size: 11px; color: var(--text-tertiary); text-align: center; font-weight: 500; line-height: 1.6; max-width: 85%; margin: 20px auto 0; }

        .wallet-info { display: flex; align-items: center; gap: 10px; padding: 10px 18px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 18px; font-size: 13px; font-weight: 700; cursor: pointer; max-width: 180px; }
        .wallet-info span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--error); flex-shrink: 0; }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 12px var(--success); }

        #toast-container { position: fixed; top: calc(80px + var(--safe-top)); left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; width: 90%; max-width: 420px; }
        .toast { padding: 16px 24px; border-radius: 20px; background: var(--glass-heavy); backdrop-filter: blur(25px); border: 1px solid var(--border); color: white; font-weight: 600; font-size: 14px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: toastIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; pointer-events: auto; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        footer { text-align: center; padding: 40px 20px; font-size: 11px; color: var(--text-tertiary); opacity: 0.6; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: contentFade 0.5s ease-out; }
        @keyframes contentFade { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .id-preview { margin-top: 16px; padding: 18px; background: rgba(0,0,0,0.4); border-radius: 20px; display: none; border: 1px solid var(--border); }
        .info-row { display: flex; justify-content: space-between; align-items: center; width: 100%; font-size: 13px; margin-bottom: 10px; gap: 15px; }
        .info-row span:first-child { color: var(--text-secondary); font-weight: 500; flex-shrink: 0; }
        /* Query Result Long Data Support */
        .info-row span:last-child { color: var(--text-primary); font-weight: 700; text-align: right; word-break: break-all; overflow-wrap: break-word; }
    </style>
</head>
<body>
    <div class="bg-glow"></div>
    <nav>
        <a href="#" class="logo-nav"><img src="https://www.woofswap.finance/image/tokens/sou.png" alt="SOU"><span>SOU Wallet</span></a>
        <div class="nav-right">
            <div class="lang-switch">
                <button class="lang-btn active" id="btn-zh" onclick="setLang('zh')">‰∏≠</button>
                <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
            </div>
            <div class="wallet-info" onclick="connectWallet()">
                <div class="status-dot" id="walletDot"></div>
                <span id="walletAddr" data-i18n="connectWallet">ËøûÊé•Èí±ÂåÖ</span>
            </div>
        </div>
    </nav>

    <div id="toast-container"></div>

    <div class="wrapper">
        <div class="app-container">
            <div class="card">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="assets" data-i18n="tabAssets">ËµÑ‰∫ß</button>
                    <button class="tab-btn" data-tab="send" data-i18n="tabSend">ÂèëÈÄÅ</button>
                    <button class="tab-btn" data-tab="domain" data-i18n="tabDomain">ÂüüÂêçËΩ¨Ë¥¶</button>
                    <button class="tab-btn" data-tab="query" data-i18n="tabQuery">Êü•ËØ¢</button>
                </div>

                <div class="card-content">
                    <div class="tab-content active" id="assetsTab">
                        <div class="balance-grid">
                            <div class="balance-card direct">
                                <div class="balance-header">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" alt="SOU">
                                    <span class="balance-label" data-i18n="eoaBalanceLabel">ËøûÊé•Èí±ÂåÖ‰ΩôÈ¢ù (EOA)</span>
                                </div>
                                <div class="balance-val" id="eoaBalanceDisplay">0.00</div>
                                <div class="addr-pill">
                                    <span id="eoaAddrFull" class="addr-text">Êú™ËøûÊé•</span>
                                    <span class="copy-icon" onclick="copyText('eoaAddrFull')">üìã</span>
                                </div>
                            </div>

                            <div id="noWalletUI">
                                <div class="balance-card" style="border: 2px dashed var(--border); background: transparent; min-height: 160px; justify-content: center;">
                                    <p data-i18n="noWalletTip" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; font-weight: 600;">Êú™Êã•Êúâ SOU Êô∫ËÉΩÈí±ÂåÖ</p>
                                    <div class="input-box" style="padding: 12px 16px; border-radius: 16px; margin-bottom: 12px; background: rgba(0,0,0,0.2);">
                                        <input type="text" id="regID" data-i18n-placeholder="idPlaceholder" placeholder="ËæìÂÖ•Êï∞Â≠ó ID">
                                    </div>
                                    <button class="action-button" onclick="createWallet()" data-i18n="btnCreate" style="padding: 12px; font-size: 13px; margin-top: 0; border-radius: 16px; box-shadow: none;">ÂàõÂª∫Èí±ÂåÖ</button>
                                </div>
                            </div>

                            <div id="hasWalletUI" class="balance-card smart" style="display: none;">
                                <div class="balance-header">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" alt="SOU">
                                    <span class="balance-label" data-i18n="smartBalanceLabel">SOU Êô∫ËÉΩÈí±ÂåÖ‰ΩôÈ¢ù</span>
                                </div>
                                <div class="balance-val" id="souBalance">0.00</div>
                                <div class="info-row" style="justify-content: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 11px; opacity: 0.5;">ID:</span> <b id="myID" style="color: var(--primary-light); font-size: 14px;">-</b>
                                </div>
                                <div class="addr-pill">
                                    <span id="myWalletAddrFull" class="addr-text">0x...</span>
                                    <span class="copy-icon" onclick="copyText('myWalletAddrFull')">üìã</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="sendTab">
                        <div class="input-section">
                            <div class="input-label" data-i18n="receiverLabel">Êé•Êî∂ËÄÖ (Âú∞ÂùÄÊàñÊï∞Â≠ó ID)</div>
                            <div class="input-box">
                                <input type="text" id="sendTarget" oninput="previewTarget()" data-i18n-placeholder="targetPlaceholder" placeholder="0x... Êàñ Êï∞Â≠ó ID">
                            </div>
                            <div id="targetPreview" class="id-preview">
                                <div class="id-preview-label" data-i18n="targetAddrLabel">Ëß£ÊûêÂú∞ÂùÄ</div>
                                <div class="addr-pill" style="margin-top: 8px; background: rgba(0,0,0,0.2);">
                                    <span id="previewAddr" class="addr-text">-</span>
                                    <span class="copy-icon" onclick="copyText('previewAddr')">üìã</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-section">
                            <div class="input-label">
                                <span data-i18n="amountLabel">Êï∞Èáè</span>
                                <span style="font-size: 11px; color: var(--text-tertiary); font-family: 'Space Mono';">Bal: <span class="sendBalText">0.00</span> SOU</span>
                            </div>
                            <div class="input-box">
                                <input type="number" id="sendAmt" placeholder="0.0">
                                <div class="token-badge">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" class="token-logo-small">
                                    <span style="font-size: 13px; font-weight: 800;">SOU</span>
                                </div>
                            </div>
                            <div class="percent-row">
                                <button class="percent-btn" onclick="setPercent(0.25, 'sendAmt', 'smart')">25%</button>
                                <button class="percent-btn" onclick="setPercent(0.5, 'sendAmt', 'smart')">50%</button>
                                <button class="percent-btn" onclick="setPercent(0.75, 'sendAmt', 'smart')">75%</button>
                                <button class="percent-btn" onclick="setPercent(1.0, 'sendAmt', 'smart')">MAX</button>
                            </div>
                        </div>
                        <button class="action-button" onclick="handleSend()" data-i18n="btnSend">Á´ãÂç≥ÂèëÈÄÅ</button>
                        <div class="tip-text" data-i18n="smartTip">Ê∏©È¶®ÊèêÁ§∫ÔºöSOU Êô∫ËÉΩÈí±ÂåÖ‰ªÖÊîØÊåÅÂú® SOU Èí±ÂåÖÂú∞ÂùÄ‰πãÈó¥ËøõË°åËΩ¨Ë¥¶</div>
                    </div>

                    <div class="tab-content" id="domainTab">
                        <div class="input-section">
                            <div class="input-label" data-i18n="domainLabel">Êé•Êî∂ËÄÖÂüüÂêç</div>
                            <div class="input-box">
                                <input type="text" id="domainTarget" oninput="previewDomain()" data-i18n-placeholder="domainPlaceholder" placeholder="ËæìÂÖ•ÂêçÁß∞">
                                <span class="domain-suffix">.sou</span>
                            </div>
                            <div id="domainPreview" class="id-preview">
                                <div class="id-preview-label" data-i18n="targetAddrLabel">Ëß£ÊûêÂú∞ÂùÄ</div>
                                <div class="addr-pill" style="margin-top: 8px; background: rgba(0,0,0,0.2);">
                                    <span id="previewDomainAddr" class="addr-text">-</span>
                                    <span class="copy-icon" onclick="copyText('previewDomainAddr')">üìã</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-section">
                            <div class="input-label">
                                <span data-i18n="amountLabel">Êï∞Èáè</span>
                                <span style="font-size: 11px; color: var(--text-tertiary); font-family: 'Space Mono';">Bal: <span class="directBalText">0.00</span> SOU</span>
                            </div>
                            <div class="input-box">
                                <input type="number" id="domainAmt" placeholder="0.0">
                                <div class="token-badge">
                                    <img src="https://www.woofswap.finance/image/tokens/sou.png" class="token-logo-small">
                                    <span style="font-size: 13px; font-weight: 800;">SOU</span>
                                </div>
                            </div>
                            <div class="percent-row">
                                <button class="percent-btn" onclick="setPercent(0.25, 'domainAmt', 'direct')">25%</button>
                                <button class="percent-btn" onclick="setPercent(0.5, 'domainAmt', 'direct')">50%</button>
                                <button class="percent-btn" onclick="setPercent(0.75, 'domainAmt', 'direct')">75%</button>
                                <button class="percent-btn" onclick="setPercent(1.0, 'domainAmt', 'direct')">MAX</button>
                            </div>
                        </div>
                        <button class="action-button" onclick="handleDomainSend()" data-i18n="btnSend">Á´ãÂç≥ÂèëÈÄÅ</button>
                        <div class="tip-text" data-i18n="domainTip">Ê∏©È¶®ÊèêÁ§∫ÔºöÂüüÂêçËΩ¨Ë¥¶ÊîØÊåÅÂ∞Ü SOU ÂèëÈÄÅËá≥‰ªªÊÑèËß£ÊûêÂêéÁöÑÂú∞ÂùÄ</div>
                    </div>

                    <div class="tab-content" id="queryTab">
                        <div class="input-section">
                            <div class="input-label" data-i18n="searchLabel">ÊêúÁ¥¢Âú∞ÂùÄ„ÄÅID ÊàñÂüüÂêç</div>
                            <div class="input-box">
                                <input type="text" id="queryInput" data-i18n-placeholder="searchPlaceholder" placeholder="Âú∞ÂùÄ„ÄÅID Êàñ .sou ÂüüÂêç">
                            </div>
                        </div>
                        <button class="action-button" style="background: var(--dark-3); box-shadow: none; border: 1px solid var(--border);" onclick="handleQuery()" data-i18n="btnSearch">ÊêúÁ¥¢</button>
                        <div id="queryResult" style="flex-direction: column; gap: 10px; margin-top: 24px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 24px; display: none; border: 1px solid var(--border);">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>&copy; 2026 SOU Ecosystem. Optimized for Large Data.</footer>

    <script>
        const FACTORY_ADDR = "0x02E54e08Be9fE047C6E6aEd89A430AcBe4708E9e";
        const ID_CONTRACT_ADDR = "0x31CCB08535398AFEe394E8cd8d34e72973C08cc9";
        const SOU_ADDR = "0xb65bd36fef84ebc5114cfd803a4f25b2b57f7777";
        const BSC_CHAIN_ID = 56;
        
        const i18n = {
            zh: {
                connectWallet: "ËøûÊé•Èí±ÂåÖ", tabAssets: "ËµÑ‰∫ß", tabSend: "ÂèëÈÄÅ", tabDomain: "ÂüüÂêçËΩ¨Ë¥¶", tabQuery: "Êü•ËØ¢",
                eoaBalanceLabel: "Áõ¥Êé•ÊåÅÊúâ‰ΩôÈ¢ù (EOA)", smartBalanceLabel: "Êô∫ËÉΩÈí±ÂåÖ‰ΩôÈ¢ù",
                noWalletTip: "ÊÇ®Â∞öÊú™Êã•Êúâ SOU Êô∫ËÉΩÈí±ÂåÖ", idPlaceholder: "ËæìÂÖ•Êï∞Â≠ó ID", btnCreate: "ÂàõÂª∫Èí±ÂåÖ",
                receiverLabel: "Êé•Êî∂ËÄÖ (Âú∞ÂùÄÊàñ ID)", domainLabel: "Êé•Êî∂ËÄÖÂüüÂêç",
                targetPlaceholder: "0x... Êàñ Êï∞Â≠ó ID", domainPlaceholder: "ËæìÂÖ•ÂêçÁß∞",
                targetAddrLabel: "Ëß£ÊûêÂú∞ÂùÄ", amountLabel: "ËΩ¨Ë¥¶Êï∞Èáè", btnSend: "Á´ãÂç≥ÂèëÈÄÅ",
                searchLabel: "ÊêúÁ¥¢ËµÑ‰∫ß‰∏éÂÖ≥ËÅî‰ø°ÊÅØ", searchPlaceholder: "Âú∞ÂùÄ„ÄÅID Êàñ .sou ÂüüÂêç", btnSearch: "ÂºÄÂßãÊêúÁ¥¢",
                msgCreateSuccess: "ÂàõÂª∫ÊàêÂäüÔºÅ", msgSendSuccess: "ËΩ¨Ë¥¶ÊàêÂäüÔºÅ", msgIdNotFound: "Êú™ÊâæÂà∞‰ø°ÊÅØ",
                msgInvalidTarget: "ÁõÆÊ†áÈùûÊ≥ïÔºöÈùû SOU Èí±ÂåÖÊàñÊú™Âú®ÁôΩÂêçÂçï", msgQueryEmpty: "Êú™Êü•ËØ¢Âà∞‰ø°ÊÅØ",
                msgQueryWallet: "ÂÖ≥ËÅîÈí±ÂåÖ", msgQueryOwner: "ÊâÄÊúâËÄÖ", msgQueryIsSOU: "ÊòØÂê¶‰∏∫ SOU Èí±ÂåÖ",
                msgYes: "ÊòØ", msgNo: "Âê¶", msgError: "Êìç‰ΩúÂ§±Ë¥•", msgConnectMetaMask: "ËØ∑ÂÆâË£Ö MetaMask",
                msgNetworkError: "ËØ∑ÂàáÊç¢Ëá≥ BSC ‰∏ªÁΩë (56)", msgCopySuccess: "Â∑≤Â§çÂà∂",
                smartTip: "Ê∏©È¶®ÊèêÁ§∫ÔºöSOU Êô∫ËÉΩÈí±ÂåÖ‰ªÖÊîØÊåÅÂú® SOU Èí±ÂåÖÂú∞ÂùÄ‰πãÈó¥ËøõË°åËΩ¨Ë¥¶",
                domainTip: "Ê∏©È¶®ÊèêÁ§∫ÔºöÂüüÂêçËΩ¨Ë¥¶ÊîØÊåÅÂ∞Ü SOU ÂèëÈÄÅËá≥‰ªªÊÑèËß£ÊûêÂêéÁöÑÂú∞ÂùÄ"
            },
            en: {
                connectWallet: "Connect", tabAssets: "Assets", tabSend: "Send", tabDomain: "Domain", tabQuery: "Query",
                eoaBalanceLabel: "Direct Balance (EOA)", smartBalanceLabel: "Smart Balance",
                noWalletTip: "No Smart Wallet", idPlaceholder: "Numeric ID", btnCreate: "Create",
                receiverLabel: "Receiver (Addr/ID)", domainLabel: "Receiver Domain",
                targetPlaceholder: "0x... or ID", domainPlaceholder: "Name",
                targetAddrLabel: "Resolved", amountLabel: "Amount", btnSend: "Send Now",
                searchLabel: "Search Info", searchPlaceholder: "Addr, ID or .sou", btnSearch: "Search",
                msgCreateSuccess: "Success!", msgSendSuccess: "Sent!", msgIdNotFound: "Not Found",
                msgInvalidTarget: "Invalid target", msgQueryEmpty: "No info",
                msgQueryWallet: "Wallet", msgQueryOwner: "Owner", msgQueryIsSOU: "Is SOU Wallet",
                msgYes: "Yes", msgNo: "No", msgError: "Failed", msgConnectMetaMask: "Install MetaMask",
                msgNetworkError: "Switch to BSC (56)", msgCopySuccess: "Copied!",
                smartTip: "Tip: Smart Wallet only supports transfers between SOU addresses",
                domainTip: "Tip: Domain Send supports any resolved address"
            }
        };

        let currentLang = 'zh';
        let userSmartSouBal = "0";
        let userDirectSouBal = "0";

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOut 0.4s ease forwards'; setTimeout(() => toast.remove(), 400); }, 3000);
        }

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = i18n[lang][el.dataset.i18n]);
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = i18n[lang][el.dataset.i18nPlaceholder]);
            document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
        }

        // Format number with commas and fixed decimals
        function formatNumber(numStr) {
            const val = parseFloat(numStr);
            if (isNaN(val)) return "0.00";
            return val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        const FACTORY_ABI = [
            "function createWallet(string id) external returns (address)",
            "function ownerToWallet(address) view returns (address)",
            "function walletToOwner(address) view returns (address)",
            "function isSOUWallet(address) view returns (bool)",
            "function idToWallet(string) view returns (address)",
            "function walletToId(address) view returns (string)",
            "function globalRestrictionLifted() view returns (bool)",
            "function whitelist(address) view returns (bool)"
        ];
        const ID_ABI = ["function resolve(string calldata inputName) external view returns (address)"];
        const WALLET_ABI = ["function transfer(address to, uint256 amount, address token) external"];
        const ERC20_ABI = ["function balanceOf(address) view returns (uint256)", "function transfer(address to, uint256 amount) external returns (bool)"];

        let provider, signer, userAddr, userWallet;

        async function connectWallet() {
            if (!window.ethereum) return showToast(i18n[currentLang].msgConnectMetaMask, 'error');
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const { chainId } = await provider.getNetwork();
            if (chainId !== BSC_CHAIN_ID) return showToast(i18n[currentLang].msgNetworkError, 'error');
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddr = await signer.getAddress();
            document.getElementById('walletAddr').innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
            document.getElementById('eoaAddrFull').innerText = userAddr;
            document.getElementById('walletDot').classList.add('connected');
            await refreshUI();
        }

        async function refreshUI() {
            if (!userAddr) return;
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            const sou = new ethers.Contract(SOU_ADDR, ERC20_ABI, provider);
            const directBal = await sou.balanceOf(userAddr);
            userDirectSouBal = ethers.utils.formatUnits(directBal, 18);
            document.getElementById('eoaBalanceDisplay').innerText = formatNumber(userDirectSouBal);
            document.querySelectorAll('.directBalText').forEach(el => el.innerText = formatNumber(userDirectSouBal));

            userWallet = await factory.ownerToWallet(userAddr);
            if (userWallet !== "0x0000000000000000000000000000000000000000") {
                document.getElementById('noWalletUI').style.display = 'none';
                document.getElementById('hasWalletUI').style.display = 'block';
                document.getElementById('myID').innerText = await factory.walletToId(userWallet);
                document.getElementById('myWalletAddrFull').innerText = userWallet;
                const smartBal = await sou.balanceOf(userWallet);
                userSmartSouBal = ethers.utils.formatUnits(smartBal, 18);
                document.getElementById('souBalance').innerText = formatNumber(userSmartSouBal);
                document.querySelectorAll('.sendBalText').forEach(el => el.innerText = formatNumber(userSmartSouBal));
            } else {
                document.getElementById('noWalletUI').style.display = 'block';
                document.getElementById('hasWalletUI').style.display = 'none';
                document.querySelectorAll('.sendBalText').forEach(el => el.innerText = "0.00");
            }
        }

        async function createWallet() {
            const id = document.getElementById('regID').value;
            if (!id || isNaN(id)) return;
            try {
                const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, signer);
                const tx = await factory.createWallet(id);
                showToast("Pending...", 'info');
                await tx.wait();
                showToast(i18n[currentLang].msgCreateSuccess, 'success');
                await refreshUI();
            } catch (e) { showToast(i18n[currentLang].msgError, 'error'); }
        }

        async function previewTarget() {
            const target = document.getElementById('sendTarget').value.trim();
            const previewBox = document.getElementById('targetPreview');
            const previewAddr = document.getElementById('previewAddr');
            if (!target) { previewBox.style.display = 'none'; return; }
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            if (!target.startsWith("0x") && !isNaN(target)) {
                const addr = await factory.idToWallet(target);
                if (addr !== "0x0000000000000000000000000000000000000000") { previewAddr.innerText = addr; previewBox.style.display = 'block'; }
                else { previewBox.style.display = 'none'; }
            } else { previewBox.style.display = 'none'; }
        }

        async function previewDomain() {
            let domainInput = document.getElementById('domainTarget').value.trim();
            const previewBox = document.getElementById('domainPreview');
            const previewAddr = document.getElementById('previewDomainAddr');
            if (!domainInput) { previewBox.style.display = 'none'; return; }
            let searchName = domainInput.toLowerCase();
            if (searchName.endsWith(".sou")) searchName = searchName.substring(0, searchName.length - 4);
            try {
                const idContract = new ethers.Contract(ID_CONTRACT_ADDR, ID_ABI, provider);
                const addr = await idContract.resolve(searchName);
                if (addr !== "0x0000000000000000000000000000000000000000") { previewAddr.innerText = addr; previewBox.style.display = 'block'; }
                else { previewBox.style.display = 'none'; }
            } catch (e) { previewBox.style.display = 'none'; }
        }

        function setPercent(p, inputId, type) {
            let baseBal = (type === 'smart') ? userSmartSouBal : userDirectSouBal;
            let val = parseFloat(baseBal) * p;
            if (p === 1.0) val = Math.floor(val * 1000000) / 1000000;
            document.getElementById(inputId).value = val;
        }

        async function handleSend() {
            let target = document.getElementById('sendTarget').value.trim();
            const amt = document.getElementById('sendAmt').value;
            if (!target || !amt) return;
            let targetAddr = target;
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            if (!target.startsWith("0x") && !isNaN(target)) {
                targetAddr = await factory.idToWallet(target);
                if (targetAddr === "0x0000000000000000000000000000000000000000") return showToast(i18n[currentLang].msgIdNotFound, 'error');
            }
            try {
                const isSOU = await factory.isSOUWallet(targetAddr);
                const globalLifted = await factory.globalRestrictionLifted();
                const isWhite = await factory.whitelist(userWallet);
                if (!isSOU && !globalLifted && !isWhite) return showToast(i18n[currentLang].msgInvalidTarget, 'error');
                const wallet = new ethers.Contract(userWallet, WALLET_ABI, signer);
                const tx = await wallet.transfer(targetAddr, ethers.utils.parseUnits(amt.toString(), 18), SOU_ADDR);
                showToast("Sending...", 'info');
                await tx.wait();
                showToast(i18n[currentLang].msgSendSuccess, 'success');
                await refreshUI();
            } catch (e) { showToast(i18n[currentLang].msgError, 'error'); }
        }

        async function handleDomainSend() {
            let domainInput = document.getElementById('domainTarget').value.trim();
            const amt = document.getElementById('domainAmt').value;
            if (!domainInput || !amt) return;
            let searchName = domainInput.toLowerCase();
            if (searchName.endsWith(".sou")) searchName = searchName.substring(0, searchName.length - 4);
            try {
                const idContract = new ethers.Contract(ID_CONTRACT_ADDR, ID_ABI, provider);
                const targetAddr = await idContract.resolve(searchName);
                if (targetAddr === "0x0000000000000000000000000000000000000000") return showToast(i18n[currentLang].msgIdNotFound, 'error');
                const sou = new ethers.Contract(SOU_ADDR, ERC20_ABI, signer);
                const tx = await sou.transfer(targetAddr, ethers.utils.parseUnits(amt.toString(), 18));
                showToast("Sending...", 'info');
                await tx.wait();
                showToast(i18n[currentLang].msgSendSuccess, 'success');
                await refreshUI();
            } catch (e) { showToast(i18n[currentLang].msgError, 'error'); }
        }

        async function handleQuery() {
            const input = document.getElementById('queryInput').value.trim();
            const resBox = document.getElementById('queryResult');
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            const idContract = new ethers.Contract(ID_CONTRACT_ADDR, ID_ABI, provider);
            try {
                let resHtml = "";
                const lang = i18n[currentLang];
                if (input.startsWith("0x") && input.length === 42) {
                    const wallet = await factory.ownerToWallet(input);
                    const owner = await factory.walletToOwner(input);
                    if (wallet !== "0x0000000000000000000000000000000000000000") resHtml += `<div class="info-row"><span>${lang.msgQueryWallet}:</span><span>${wallet} <span class="copy-icon" onclick="copyValue('${wallet}')">üìã</span></span></div>`;
                    if (owner !== "0x0000000000000000000000000000000000000000") resHtml += `<div class="info-row"><span>${lang.msgQueryOwner}:</span><span>${owner} <span class="copy-icon" onclick="copyValue('${owner}')">üìã</span></span></div>`;
                    resHtml += `<div class="info-row"><span>${lang.msgQueryIsSOU}:</span><span>${await factory.isSOUWallet(input) ? lang.msgYes : lang.msgNo}</span></div>`;
                } else if (input.toLowerCase().endsWith(".sou")) {
                    let searchName = input.toLowerCase().substring(0, input.length - 4);
                    const addr = await idContract.resolve(searchName);
                    resHtml = addr !== "0x0000000000000000000000000000000000000000" ? `<div class="info-row"><span>${lang.msgQueryWallet}:</span><span>${addr} <span class="copy-icon" onclick="copyValue('${addr}')">üìã</span></span></div>` : `<div>${lang.msgIdNotFound}</div>`;
                } else if (!isNaN(input) && input.length > 0) {
                    const wallet = await factory.idToWallet(input);
                    resHtml = wallet !== "0x0000000000000000000000000000000000000000" ? `<div class="info-row"><span>${lang.msgQueryWallet}:</span><span>${wallet} <span class="copy-icon" onclick="copyValue('${wallet}')">üìã</span></span></div>` : `<div>${lang.msgIdNotFound}</div>`;
                } else { resHtml = `<div>${lang.msgQueryEmpty}</div>`; }
                resBox.innerHTML = resHtml; resBox.style.display = 'flex';
            } catch (e) { showToast(lang.msgError, 'error'); }
        }

        function copyText(id) {
            const txt = document.getElementById(id).innerText;
            if (txt === "Êú™ËøûÊé•" || txt === "0x..." || txt === "Connect") return;
            const fullTxt = (id === 'eoaAddrFull') ? userAddr : (id === 'myWalletAddrFull' ? userWallet : txt);
            navigator.clipboard.writeText(fullTxt).then(() => showToast(i18n[currentLang].msgCopySuccess, 'success'));
        }
        function copyValue(val) { navigator.clipboard.writeText(val).then(() => showToast(i18n[currentLang].msgCopySuccess, 'success')); }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            };
        });

        if (window.ethereum && window.ethereum.selectedAddress) connectWallet();
        setLang('zh');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShibOwesYouID</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        :root {
            --primary: #F1A849;
            --primary-hover: #d9933a;
            --dark-1: #0a0a0a;
            --dark-2: #141414;
            --dark-3: #1f1f1f;
            --dark-4: #2a2a2a;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
            --success: #10b981;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--dark-1);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, #2a1f10 0%, #0a0a0a 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        nav {
            height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 22px;
            letter-spacing: -0.5px;
        }

        .logo img {
            width: 40px;
            height: 40px;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-dim);
            text-decoration: none;
            font-weight: 500;
            transition: 0.3s;
            font-size: 15px;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .lang-toggle {
            background: var(--dark-3);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            transition: 0.3s;
        }

        .lang-toggle:hover {
            background: var(--primary);
            color: #000;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--dark-3);
            color: var(--text-main);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--dark-4);
            border-color: var(--primary);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hero {
            padding: 80px 0 40px;
            text-align: center;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #fff 0%, #F1A849 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            background: var(--dark-2);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-dim);
            font-size: 14px;
            font-weight: 500;
        }

        .input-wrapper {
            position: relative;
        }

        input {
            width: 100%;
            background: var(--dark-3);
            border: 1px solid var(--border);
            padding: 15px 20px;
            border-radius: 12px;
            color: var(--text-main);
            font-size: 16px;
            outline: none;
            transition: 0.3s;
        }

        input:focus {
            border-color: var(--primary);
            background: var(--dark-4);
        }

        input::placeholder {
            color: var(--text-dim);
        }

        .suffix-hint {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: var(--dark-3);
            padding: 5px;
            border-radius: 14px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            transition: 0.3s;
            color: var(--text-dim);
        }

        .tab.active {
            background: var(--dark-4);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .message {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.info { background: rgba(241, 168, 73, 0.1); color: var(--primary); border: 1px solid rgba(241, 168, 73, 0.2); display: block; }
        .message.success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); display: block; }
        .message.error { background: rgba(239, 68, 68, 0.1); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.2); display: block; }

        .domain-item {
            background: var(--dark-3);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }

        .domain-item:hover {
            border-color: var(--primary);
            transform: scale(1.01);
        }

        .domain-name {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-main);
            display: flex;
            align-items: center;
        }

        .domain-id {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .primary-badge {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            margin-left: 10px;
            text-transform: uppercase;
        }

        .result-box {
            background: var(--dark-4);
            padding: 20px;
            border-radius: 12px;
            border: 1px dashed var(--border);
            word-break: break-all;
        }

        .result-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-family: 'Space Mono', monospace;
            font-size: 15px;
            color: var(--primary);
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .info-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .nav-links { display: none; }
            .hero h1 { font-size: 32px; }
            .domain-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .info-box { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="logo">
                <img src="https://www.woofswap.finance/image/tokens/sou.png" alt="SOU">
                <span>ShibOwesYouID</span>
            </div>
            <div class="nav-links">
                <a href="#mint-section" class="nav-mint">é“¸é€ </a>
                <a href="#query-section" class="nav-query">æŸ¥è¯¢</a>
                <a href="#my-domains" class="nav-domains">æˆ‘çš„åŸŸå</a>
            </div>
            <div class="wallet-section">
                <button class="lang-toggle" onclick="toggleLanguage()">ä¸­æ–‡ / EN</button>
                <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
                <button id="disconnectBtn" class="btn btn-secondary" style="display: none;" onclick="disconnectWallet()">æ–­å¼€</button>
            </div>
        </nav>

        <section class="hero">
            <h1 id="heroTitle">æ‚¨çš„é“¾ä¸Šèº«ä»½ç”± .sou å¼€å¯</h1>
            <p id="heroSub" style="color: var(--text-dim);">ç®€å•ã€ç‹¬ç‰¹ã€å±äºæ‚¨çš„ Web3 åŸŸåæœåŠ¡</p>
        </section>

        <section id="mint-section" class="card">
            <h2 id="mintTitle" style="margin-bottom: 25px;">ğŸ¯ é“¸é€ æ–°åŸŸå</h2>
            <div id="mintMessage" class="message"></div>
            
            <div class="input-group">
                <label id="labelDomain">è¾“å…¥æ‚¨æƒ³è¦çš„åŸŸå</label>
                <div class="input-wrapper">
                    <input type="text" id="domainName" placeholder="ä¾‹å¦‚: shib" maxlength="15">
                    <span class="suffix-hint">.sou</span>
                </div>
            </div>

            <div class="info-box">
                <div class="result-box">
                    <div class="result-label" id="labelFee">é“¸é€ è´¹ç”¨</div>
                    <div class="result-value">1000 SOU</div>
                </div>
                <div class="result-box">
                    <div class="result-label" id="labelBalance">æ‚¨çš„ SOU ä½™é¢</div>
                    <div class="result-value" id="souBalance">0.00</div>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; height: 56px; font-size: 16px;" onclick="handleMint()">
                <span id="btnMint">ç«‹å³é“¸é€ </span>
            </button>
        </section>

        <section id="query-section" class="card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('resolve')" id="tabResolve">åŸŸåè§£æ</div>
                <div class="tab" onclick="switchTab('reverse')" id="tabReverse">åå‘æŸ¥è¯¢</div>
                <div class="tab" onclick="switchTab('set-primary')" id="tabSetPrimary">è®¾ç½®ä¸»åŸŸå</div>
            </div>

            <div id="resolve" class="tab-content active">
                <div id="resolveMessage" class="message"></div>
                <div class="input-group">
                    <label id="labelResolveName">è¾“å…¥åŸŸåæŸ¥è¯¢é’±åŒ…åœ°å€</label>
                    <input type="text" id="resolveName" placeholder="ä¾‹å¦‚: shib.sou">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="resolveDomain()">
                    <span id="btnResolve">å¼€å§‹æŸ¥è¯¢</span>
                </button>
                <div id="resolveResult" class="result-box" style="display: none; margin-top: 20px;">
                    <div class="result-label" id="resLabelAddr">æŒæœ‰è€…åœ°å€</div>
                    <div class="result-value" id="resolveResultValue"></div>
                </div>
            </div>

            <div id="reverse" class="tab-content">
                <div id="reverseMessage" class="message"></div>
                <div class="input-group">
                    <label id="labelReverseAddr">è¾“å…¥é’±åŒ…åœ°å€æŸ¥è¯¢ä¸»åŸŸå</label>
                    <input type="text" id="reverseAddress" placeholder="0x...">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="reverseDomain()">
                    <span id="btnReverse">å¼€å§‹æŸ¥è¯¢</span>
                </button>
                <div id="reverseResult" class="result-box" style="display: none; margin-top: 20px;">
                    <div class="result-label" id="resLabelDomain">ä¸»åŸŸå</div>
                    <div class="result-value" id="reverseResultValue"></div>
                </div>
            </div>

            <div id="set-primary" class="tab-content">
                <div id="setPrimaryMessage" class="message"></div>
                <div class="input-group">
                    <label id="labelSetPrimary">è¾“å…¥æ‚¨æ‹¥æœ‰çš„åŸŸåè®¾ä¸ºä¸»åŸŸå</label>
                    <input type="text" id="setPrimaryNameInput" placeholder="ä¾‹å¦‚: shib">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="setPrimaryNameManual()">
                    <span id="btnSetPrimary">ç¡®è®¤è®¾ç½®</span>
                </button>
            </div>
        </section>

        <section id="my-domains" class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 id="myDomainsTitle">ğŸ“‹ æˆ‘çš„åŸŸå</h2>
                <button class="btn btn-secondary" onclick="loadMyDomains()" style="padding: 8px 16px; font-size: 12px;" id="btnRefresh">åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="myDomainsMessage" class="message"></div>
            <div id="domainsList">
                <div class="empty-state">
                    <p id="emptyMsg">è¯·å…ˆè¿æ¥é’±åŒ…æŸ¥çœ‹æ‚¨çš„åŸŸå</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        const CONFIG = {
            CONTRACT: '0x57FD3175Fb85156Ec8E0DD63cCB2136f88B48183',
            SOU_TOKEN: '0xb65bD36fef84ebc5114Cfd803A4F25B2b57F7777',
            CHAIN_ID: '0x38',
            RPC: 'https://bsc-dataseed.binance.org/'
        };

        const ABI = [
            {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"string","name":"inputName","type":"string"}],"name":"resolve","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"primaryName","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getNameByTokenId","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"inputName","type":"string"}],"name":"setPrimaryName","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        const ERC20_ABI = [
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        const LANG = {
            zh: {
                navMint: 'é“¸é€ ', navQuery: 'æŸ¥è¯¢', navDomains: 'æˆ‘çš„åŸŸå',
                heroTitle: 'æ‚¨çš„é“¾ä¸Šèº«ä»½ç”± .sou å¼€å¯', heroSub: 'ç®€å•ã€ç‹¬ç‰¹ã€å±äºæ‚¨çš„ Web3 åŸŸåæœåŠ¡',
                mintTitle: 'ğŸ¯ é“¸é€ æ–°åŸŸå', labelDomain: 'è¾“å…¥æ‚¨æƒ³è¦çš„åŸŸå', labelFee: 'é“¸é€ è´¹ç”¨', labelBalance: 'æ‚¨çš„ SOU ä½™é¢', btnMint: 'ç«‹å³é“¸é€ ',
                tabResolve: 'åŸŸåè§£æ', tabReverse: 'åå‘æŸ¥è¯¢', tabSetPrimary: 'è®¾ç½®ä¸»åŸŸå',
                labelResolveName: 'è¾“å…¥åŸŸåæŸ¥è¯¢é’±åŒ…åœ°å€', btnResolve: 'å¼€å§‹æŸ¥è¯¢', resLabelAddr: 'æŒæœ‰è€…åœ°å€',
                labelReverseAddr: 'è¾“å…¥é’±åŒ…åœ°å€æŸ¥è¯¢ä¸»åŸŸå', btnReverse: 'å¼€å§‹æŸ¥è¯¢', resLabelDomain: 'ä¸»åŸŸå',
                labelSetPrimary: 'è¾“å…¥æ‚¨æ‹¥æœ‰çš„åŸŸåè®¾ä¸ºä¸»åŸŸå', btnSetPrimary: 'ç¡®è®¤è®¾ç½®',
                myDomainsTitle: 'ğŸ“‹ æˆ‘çš„åŸŸå', btnRefresh: 'åˆ·æ–°åˆ—è¡¨', emptyMsg: 'è¯·å…ˆè¿æ¥é’±åŒ…æŸ¥çœ‹æ‚¨çš„åŸŸå',
                noDomains: 'æ‚¨è¿˜æ²¡æœ‰æ‹¥æœ‰ä»»ä½• .sou åŸŸå', currentPrimary: 'å½“å‰ä¸»åŸŸå', setAsMain: 'è®¾ä¸ºä¸»åŸŸå',
                connect: 'è¿æ¥é’±åŒ…', disconnect: 'æ–­å¼€è¿æ¥', loading: 'å¤„ç†ä¸­...', success: 'æ“ä½œæˆåŠŸ', fail: 'æ“ä½œå¤±è´¥ï¼š',
                switchNet: 'è¯·åˆ‡æ¢åˆ° BSC ç½‘ç»œ', installMetamask: 'è¯·å®‰è£… MetaMask',
                approving: 'æ­£åœ¨æˆæƒ SOU...', minting: 'æ­£åœ¨é“¸é€ ...', querySuccess: 'æŸ¥è¯¢æˆåŠŸ', queryFail: 'æŸ¥è¯¢å¤±è´¥',
                notFound: 'æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯', invalidAddr: 'æ— æ•ˆçš„åœ°å€', inputName: 'è¯·è¾“å…¥åŸŸå',
                domainPlaceholder: 'ä¾‹å¦‚: shib', addressPlaceholder: '0x...'
            },
            en: {
                navMint: 'Mint', navQuery: 'Query', navDomains: 'Domains',
                heroTitle: 'Your On-chain Identity Starts with .sou', heroSub: 'Simple, Unique, Your Own Web3 Domain Service',
                mintTitle: 'ğŸ¯ Mint New Domain', labelDomain: 'Enter desired domain name', labelFee: 'Mint Fee', labelBalance: 'Your SOU Balance', btnMint: 'Mint Now',
                tabResolve: 'Resolve', tabReverse: 'Reverse Lookup', tabSetPrimary: 'Set Primary',
                labelResolveName: 'Enter domain to find address', btnResolve: 'Resolve Now', resLabelAddr: 'Owner Address',
                labelReverseAddr: 'Enter address to find primary domain', btnReverse: 'Lookup Now', resLabelDomain: 'Primary Domain',
                labelSetPrimary: 'Enter your domain to set as primary', btnSetPrimary: 'Set Primary',
                myDomainsTitle: 'ğŸ“‹ My Domains', btnRefresh: 'Refresh', emptyMsg: 'Connect wallet to see your domains',
                noDomains: 'You don\'t own any .sou domains yet', currentPrimary: 'Current Primary', setAsMain: 'Set Primary',
                connect: 'Connect Wallet', disconnect: 'Disconnect', loading: 'Processing...', success: 'Success', fail: 'Failed: ',
                switchNet: 'Please switch to BSC Network', installMetamask: 'Please install MetaMask',
                approving: 'Approving SOU...', minting: 'Minting...', querySuccess: 'Query successful', queryFail: 'Query failed',
                notFound: 'Not found', invalidAddr: 'Invalid address', inputName: 'Please enter a name',
                domainPlaceholder: 'e.g: shib', addressPlaceholder: '0x...'
            }
        };

        let currentLang = 'zh';
        let web3, account, contract, tokenContract;

        function t(key) { return LANG[currentLang][key]; }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateAllUI();
        }

        function updateAllUI() {
            document.querySelector('.lang-toggle').textContent = currentLang === 'zh' ? 'ä¸­æ–‡ / EN' : 'EN / ä¸­æ–‡';
            
            document.querySelector('.nav-mint').textContent = t('navMint');
            document.querySelector('.nav-query').textContent = t('navQuery');
            document.querySelector('.nav-domains').textContent = t('navDomains');
            
            document.getElementById('heroTitle').textContent = t('heroTitle');
            document.getElementById('heroSub').textContent = t('heroSub');
            
            document.getElementById('mintTitle').textContent = t('mintTitle');
            document.getElementById('labelDomain').textContent = t('labelDomain');
            document.getElementById('labelFee').textContent = t('labelFee');
            document.getElementById('labelBalance').textContent = t('labelBalance');
            document.getElementById('btnMint').textContent = t('btnMint');
            document.getElementById('domainName').placeholder = t('domainPlaceholder');
            
            document.getElementById('tabResolve').textContent = t('tabResolve');
            document.getElementById('tabReverse').textContent = t('tabReverse');
            document.getElementById('tabSetPrimary').textContent = t('tabSetPrimary');
            
            document.getElementById('labelResolveName').textContent = t('labelResolveName');
            document.getElementById('btnResolve').textContent = t('btnResolve');
            document.getElementById('resLabelAddr').textContent = t('resLabelAddr');
            document.getElementById('resolveName').placeholder = currentLang === 'zh' ? 'ä¾‹å¦‚: shib.sou' : 'e.g: shib.sou';
            
            document.getElementById('labelReverseAddr').textContent = t('labelReverseAddr');
            document.getElementById('btnReverse').textContent = t('btnReverse');
            document.getElementById('resLabelDomain').textContent = t('resLabelDomain');
            document.getElementById('reverseAddress').placeholder = t('addressPlaceholder');
            
            document.getElementById('labelSetPrimary').textContent = t('labelSetPrimary');
            document.getElementById('btnSetPrimary').textContent = t('btnSetPrimary');
            document.getElementById('setPrimaryNameInput').placeholder = currentLang === 'zh' ? 'ä¾‹å¦‚: shib' : 'e.g: shib';
            
            document.getElementById('myDomainsTitle').textContent = t('myDomainsTitle');
            document.getElementById('btnRefresh').textContent = t('btnRefresh');
            document.getElementById('emptyMsg').textContent = t('emptyMsg');
            
            document.getElementById('connectBtn').textContent = account ? account.substring(0,6)+'...'+account.substring(38) : t('connect');
        }

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    web3 = new Web3(window.ethereum);
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    
                    const chainId = await web3.eth.getChainId();
                    if (chainId !== 56) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: CONFIG.CHAIN_ID }],
                            });
                        } catch (e) {
                            alert(t('switchNet'));
                            return;
                        }
                    }

                    contract = new web3.eth.Contract(ABI, CONFIG.CONTRACT);
                    tokenContract = new web3.eth.Contract(ERC20_ABI, CONFIG.SOU_TOKEN);
                    
                    document.getElementById('connectBtn').textContent = account.substring(0,6)+'...'+account.substring(38);
                    document.getElementById('disconnectBtn').style.display = 'inline-flex';
                    
                    updateSOUBalance();
                    loadMyDomains();
                    updateAllUI();
                } catch (error) {
                    console.error(error);
                }
            } else {
                alert(t('installMetamask'));
            }
        }

        function disconnectWallet() {
            account = null;
            document.getElementById('connectBtn').textContent = t('connect');
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('domainsList').innerHTML = `<div class="empty-state"><p id="emptyMsg">${t('emptyMsg')}</p></div>`;
            document.getElementById('souBalance').textContent = '0.00';
            updateAllUI();
        }

        async function updateSOUBalance() {
            if (!account || !tokenContract) return;
            const bal = await tokenContract.methods.balanceOf(account).call();
            document.getElementById('souBalance').textContent = parseFloat(web3.utils.fromWei(bal, 'ether')).toFixed(2);
        }

        function showMsg(id, text, type) {
            const el = document.getElementById(id);
            if (!text) {
                el.style.display = 'none';
                return;
            }
            el.textContent = text;
            el.className = 'message ' + type;
            el.style.display = 'block';
        }

        async function handleMint() {
            if (!account) return connectWallet();
            const name = document.getElementById('domainName').value.trim();
            if (!name) return showMsg('mintMessage', t('inputName'), 'error');

            try {
                showMsg('mintMessage', t('approving'), 'info');
                const fee = web3.utils.toWei('1000', 'ether');
                const allowance = await tokenContract.methods.allowance(account, CONFIG.CONTRACT).call();
                
                if (BigInt(allowance) < BigInt(fee)) {
                    await tokenContract.methods.approve(CONFIG.CONTRACT, fee).send({ from: account });
                }

                showMsg('mintMessage', t('minting'), 'info');
                await contract.methods.mint(name).send({ from: account });
                showMsg('mintMessage', t('success'), 'success');
                document.getElementById('domainName').value = '';
                updateSOUBalance();
                loadMyDomains();
            } catch (e) {
                showMsg('mintMessage', t('fail') + e.message, 'error');
            }
        }

        async function resolveDomain() {
            if (!contract) return connectWallet();
            let name = document.getElementById('resolveName').value.trim();
            if (name.toLowerCase().endsWith('.sou')) name = name.slice(0, -4);
            if (!name) return showMsg('resolveMessage', t('inputName'), 'error');
            
            try {
                showMsg('resolveMessage', t('loading'), 'info');
                const addr = await contract.methods.resolve(name).call();
                if (addr && addr !== '0x0000000000000000000000000000000000000000') {
                    document.getElementById('resolveResultValue').textContent = addr;
                    document.getElementById('resolveResult').style.display = 'block';
                    showMsg('resolveMessage', t('querySuccess'), 'success');
                } else {
                    showMsg('resolveMessage', t('notFound'), 'error');
                    document.getElementById('resolveResult').style.display = 'none';
                }
            } catch (e) {
                showMsg('resolveMessage', t('queryFail'), 'error');
            }
        }

        async function reverseDomain() {
            if (!contract) return connectWallet();
            const addr = document.getElementById('reverseAddress').value.trim();
            if (!addr) return showMsg('reverseMessage', t('inputName'), 'error');
            if (!web3.utils.isAddress(addr)) return showMsg('reverseMessage', t('invalidAddr'), 'error');

            try {
                showMsg('reverseMessage', t('loading'), 'info');
                const name = await contract.methods.primaryName(addr).call();
                if (name) {
                    document.getElementById('reverseResultValue').textContent = name + '.sou';
                    document.getElementById('reverseResult').style.display = 'block';
                    showMsg('reverseMessage', t('querySuccess'), 'success');
                } else {
                    showMsg('reverseMessage', t('notFound'), 'error');
                    document.getElementById('reverseResult').style.display = 'none';
                }
            } catch (e) {
                showMsg('reverseMessage', t('queryFail'), 'error');
            }
        }

        async function setPrimaryNameManual() {
            if (!account) return connectWallet();
            let name = document.getElementById('setPrimaryNameInput').value.trim();
            if (name.toLowerCase().endsWith('.sou')) name = name.slice(0, -4);
            if (!name) return showMsg('setPrimaryMessage', t('inputName'), 'error');
            try {
                showMsg('setPrimaryMessage', t('loading'), 'info');
                await contract.methods.setPrimaryName(name).send({ from: account });
                showMsg('setPrimaryMessage', t('success'), 'success');
                document.getElementById('setPrimaryNameInput').value = '';
                loadMyDomains();
            } catch (e) {
                showMsg('setPrimaryMessage', t('fail') + e.message, 'error');
            }
        }

        async function loadMyDomains() {
            if (!account || !contract) return;
            try {
                const bal = await contract.methods.balanceOf(account).call();
                const count = parseInt(bal);
                const primary = await contract.methods.primaryName(account).call();
                
                if (count === 0) {
                    document.getElementById('domainsList').innerHTML = `<div class="empty-state"><p>${t('noDomains')}</p></div>`;
                    return;
                }

                let html = '';
                for (let i = 0; i < count; i++) {
                    const tid = await contract.methods.tokenOfOwnerByIndex(account, i).call();
                    const name = await contract.methods.getNameByTokenId(tid).call();
                    const isPrimary = primary && name.toLowerCase() === primary.toLowerCase();
                    
                    html += `
                        <div class="domain-item">
                            <div>
                                <div class="domain-name">
                                    ${name}.sou
                                    ${isPrimary ? `<span class="primary-badge">${t('currentPrimary')}</span>` : ''}
                                </div>
                                <div class="domain-id">Token ID: ${tid}</div>
                            </div>
                            <button class="btn btn-secondary" onclick="setPrimary('${name}')" ${isPrimary ? 'disabled' : ''}>
                                ${t('setAsMain')}
                            </button>
                        </div>
                    `;
                }
                document.getElementById('domainsList').innerHTML = html;
            } catch (e) {
                console.error(e);
            }
        }

        async function setPrimary(name) {
            try {
                showMsg('myDomainsMessage', t('loading'), 'info');
                await contract.methods.setPrimaryName(name).send({ from: account });
                showMsg('myDomainsMessage', t('success'), 'success');
                loadMyDomains();
            } catch (e) {
                showMsg('myDomainsMessage', t('fail') + e.message, 'error');
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabMap = { 'resolve': 'Resolve', 'reverse': 'Reverse', 'set-primary': 'SetPrimary' };
            const tabName = tabMap[tabId];
            document.getElementById('tab' + tabName).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        window.ethereum?.on('accountsChanged', (accounts) => {
            if (accounts.length > 0) {
                account = accounts[0];
                connectWallet();
            } else {
                disconnectWallet();
            }
        });

        window.ethereum?.on('chainChanged', () => window.location.reload());

        updateAllUI();
    </script>
</body>
</html>
